"""Agente de busca de eventos."""

import asyncio
import json
import logging
from datetime import datetime
from typing import Any

from agno.agent import Agent
from agno.models.openai import OpenAIChat

from config import MODELS, OPENROUTER_API_KEY, OPENROUTER_BASE_URL, SEARCH_CONFIG

logger = logging.getLogger(__name__)


class SearchAgent:
    """Agente respons√°vel por buscar eventos em m√∫ltiplas fontes."""

    def __init__(self):

        # Agente de busca com Perplexity Sonar Pro (busca web em tempo real)
        self.search_agent = Agent(
            name="Event Search Agent",
            model=OpenAIChat(
                id=MODELS["search"],  # perplexity/sonar-pro
                api_key=OPENROUTER_API_KEY,
                base_url=OPENROUTER_BASE_URL,
            ),
            description="Agente com busca web em tempo real para encontrar eventos culturais no Rio de Janeiro",
            instructions=[
                f"Voc√™ tem acesso √† busca web em tempo real. Use para encontrar eventos no Rio de Janeiro "
                f"entre {SEARCH_CONFIG['start_date'].strftime('%d/%m/%Y')} "
                f"e {SEARCH_CONFIG['end_date'].strftime('%d/%m/%Y')}",
                "Busque nas seguintes categorias:",
                "1. Shows de jazz no Rio (pr√≥ximas 3 semanas)",
                "2. Teatro com√©dia/stand-up no Rio (EXCETO eventos infantis)",
                "3. Eventos na Casa do Choro, Sala Cec√≠lia Meirelles e Teatro Municipal",
                "4. Eventos ao ar livre em fim de semana no Rio",
                "Para cada evento, extrair: t√≠tulo, data completa, hor√°rio, local, valor/pre√ßo, link para compra de ingressos",
                "Buscar em sites como: Sympla, Eventbrite, Fever, TimeOut Rio, sites oficiais dos locais",
                "Retorne no formato JSON estruturado",
            ],
            markdown=True,
        )

        # Agente otimizador de queries (usa modelo r√°pido para melhorar prompts)
        self.query_optimizer = Agent(
            name="Query Optimizer Agent",
            model=OpenAIChat(
                id=MODELS["verify"],  # gpt-5-mini (r√°pido e barato)
                api_key=OPENROUTER_API_KEY,
                base_url=OPENROUTER_BASE_URL,
            ),
            description="Agente especializado em otimizar e refinar queries de busca",
            instructions=[
                "Voc√™ √© um especialista em criar queries de busca otimizadas",
                "Analise o contexto fornecido e gere prompts de busca espec√≠ficos e eficazes",
                "Use t√©cnicas de: especificidade geogr√°fica, temporal, e por venue",
                "Sugira palavras-chave alternativas e sin√¥nimos relevantes",
                "Identifique gaps e √°reas que precisam de busca mais direcionada",
            ],
            markdown=True,
        )

    def optimize_search_prompt(self, base_prompt: str, search_type: str) -> str:
        """Otimiza prompt de busca usando LLM antes de passar para Perplexity."""
        logger.info(f"Otimizando prompt de busca ({search_type})...")

        optimization_prompt = f"""
Voc√™ √© um especialista em otimiza√ß√£o de queries de busca para eventos culturais.

Analise o prompt de busca abaixo e MELHORE-O para maximizar os resultados no Perplexity Sonar Pro.

PROMPT ORIGINAL:
{base_prompt}

TAREFAS DE OTIMIZA√á√ÉO:

1. **Adicionar palavras-chave alternativas e sin√¥nimos**:
   - Para "jazz": incluir "m√∫sica instrumental", "jazz fusion", "bossa nova instrumental"
   - Para "com√©dia": incluir "humor adulto", "stand-up comedy", "improv"
   - Para "ao ar livre": incluir "outdoor", "open air", "a c√©u aberto"

2. **Refinar especificidade geogr√°fica**:
   - Adicionar bairros espec√≠ficos al√©m dos j√° mencionados
   - Incluir landmarks e refer√™ncias geogr√°ficas conhecidas
   - Sugerir √°reas alternativas relevantes

3. **Ampliar fontes de busca**:
   - Al√©m das j√° listadas, sugerir: blogs culturais, Instagram de venues, p√°ginas Facebook oficiais
   - Sites de turismo: Visit Rio, Rio+
   - Agendas culturais: Guia da Semana, Catraca Livre

4. **Adicionar instru√ß√µes de verifica√ß√£o**:
   - Confirmar datas dentro do per√≠odo
   - Verificar se links s√£o espec√≠ficos (n√£o apenas homepage)
   - Priorizar eventos com informa√ß√µes completas

5. **T√©cnicas de busca avan√ßada**:
   - Sugerir usar aspas para termos exatos
   - Operadores de busca quando apropriado
   - Datas espec√≠ficas em queries

RETORNE:
Apenas o prompt OTIMIZADO, pronto para ser usado diretamente no Perplexity.
N√£o adicione coment√°rios ou explica√ß√µes, apenas o prompt melhorado.
"""

        try:
            response = self.query_optimizer.run(optimization_prompt)
            optimized = response.content.strip()

            logger.info(f"‚úì Prompt otimizado ({len(optimized)} caracteres)")
            return optimized

        except Exception as e:
            logger.warning(f"Erro ao otimizar prompt: {e}. Usando prompt original.")
            return base_prompt

    async def search_all_sources(self) -> dict[str, Any]:
        """Busca eventos usando Perplexity Sonar Pro com estrat√©gia multi-step otimizada."""
        logger.info("Iniciando busca de eventos com Perplexity Sonar Pro...")

        # Gerar strings de data din√¢micas
        start_date_str = SEARCH_CONFIG['start_date'].strftime('%d/%m/%Y')
        end_date_str = SEARCH_CONFIG['end_date'].strftime('%d/%m/%Y')
        month_year_str = SEARCH_CONFIG['start_date'].strftime('%B %Y')  # ex: "novembro 2025"
        month_str = SEARCH_CONFIG['start_date'].strftime('%B').lower()  # ex: "novembro"

        # BUSCA 1: Eventos GERAIS (multi-layer context)
        prompt_geral = f"""
Voc√™ √© um especialista em encontrar eventos culturais. Execute uma busca detalhada de eventos no Rio de Janeiro.

PER√çODO: {SEARCH_CONFIG['start_date'].strftime('%d/%m/%Y')} at√© {SEARCH_CONFIG['end_date'].strftime('%d/%m/%Y')}

ESPECIFICA√á√ïES GEOGR√ÅFICAS:
- Cidade: Rio de Janeiro, RJ, Brasil
- Regi√µes de interesse: Zona Sul (Copacabana, Ipanema, Leblon), Centro Hist√≥rico, Lapa, Barra da Tijuca

CATEGORIAS DE EVENTOS (buscar cada uma especificamente):

1. SHOWS DE JAZZ:
   - Buscar em: Blue Note Rio, Maze Jazz Club, Clube do Jazz, Jazz nos Fundos
   - Incluir: jazz tradicional, bebop, fusion, bossa nova, jazz contempor√¢neo
   - Venues: casas de jazz especializadas, bares com jazz ao vivo, hot√©is com jazz
   - Palavras-chave: "jazz Rio Janeiro {month_year_str}", "shows jazz Copacabana", "jazz ao vivo Rio"

2. TEATRO COM√âDIA E STAND-UP (ADULTO):
   - Buscar: pe√ßas teatrais de com√©dia, stand-up comedy, humor adulto, espet√°culos c√¥micos
   - EXCLUIR: eventos infantis, teatro para crian√ßas, "kids", "fam√≠lia"
   - Venues: teatros de com√©dia, Esta√ß√£o Net Rio, Teatro Riachuelo, Teatro Clara Nunes
   - Palavras-chave: "stand-up Rio {month_str}", "teatro com√©dia adulto Rio", "humor Rio de Janeiro"

3. EVENTOS AO AR LIVRE EM FIM DE SEMANA:
   - Dias: APENAS s√°bados e domingos
   - Tipos: festivais, shows ao ar livre, feiras culturais, eventos em parques
   - Locais: Aterro do Flamengo, Jockey Club, Marina da Gl√≥ria, Parque Lage, Pista Cl√°udio Coutinho
   - Palavras-chave: "festival Rio fim de semana", "evento ao ar livre s√°bado domingo Rio", "show outdoor Rio"

4. CURSOS E EVENTOS DE CAF√â (Artemis Torrefa√ß√£o):
   - Buscar: cursos de barista, degusta√ß√µes de caf√©, workshops de preparo
   - Local: Artemis Torrefa√ß√£o (Ipanema, Leblon, outras unidades Rio)
   - Tipos: cursos b√°sico/intermedi√°rio/avan√ßado, degusta√ß√£o guiada, coffee tasting, cupping
   - Palavras-chave: "Artemis Torrefa√ß√£o cursos {month_year_str}", "workshop caf√© Rio", "curso barista Ipanema"
   - Sites: artemistorrefacao.com.br, Instagram @artemistorrefacao, Sympla, Eventbrite

INFORMA√á√ïES OBRIGAT√ìRIAS PARA CADA EVENTO:
- Nome completo do evento
- Data exata (formato DD/MM/YYYY)
- Hor√°rio de in√≠cio
- Nome completo do local/venue + endere√ßo
- Pre√ßo (incluir meia-entrada se dispon√≠vel)
- Link ESPEC√çFICO para compra de ingressos (URLs completas - n√£o links gen√©ricos de homepage)
- Descri√ß√£o detalhada: tipo de evento, artistas/elenco, dura√ß√£o estimada, p√∫blico-alvo

FONTES PARA BUSCAR (priorize plataformas oficiais):
- Plataformas de venda: Sympla (sympla.com.br), Eventbrite (eventbrite.com.br), Fever (fever.com.br), Ticketmaster
- Portais culturais: TimeOut Rio, Veja Rio, O Globo Cultura, Riotur
- Sites oficiais: Blue Note Rio, sites de teatros
- Redes sociais oficiais: Instagram e Facebook dos venues

FORMATO DE RETORNO:
Retorne JSON estruturado:
{{
  "eventos": [
    {{
      "categoria": "Jazz|Teatro-Com√©dia|Outdoor-FimDeSemana",
      "titulo": "Nome do evento",
      "data": "DD/MM/YYYY",
      "horario": "HH:MM",
      "local": "Nome completo + Endere√ßo",
      "preco": "Valor completo",
      "link_ingresso": "URL espec√≠fica ou null",
      "descricao": "Descri√ß√£o detalhada"
    }}
  ]
}}

IMPORTANTE SOBRE LINKS (N√ÉO S√ÉO PRIORIT√ÅRIOS):
- O OBJETIVO PRINCIPAL √© encontrar TODOS os eventos relevantes no per√≠odo
- Links s√£o SECUND√ÅRIOS - temos um processo separado que busca links faltantes depois
- PRIORIZE links de compra de ingressos (Sympla, Eventbrite, Ticketmaster, bilheteria do venue)
- Se n√£o encontrar link de compra, ACEITE links informativos v√°lidos:
  ‚Ä¢ Artigo ou not√≠cia sobre o evento espec√≠fico
  ‚Ä¢ Post de Instagram/Facebook do venue anunciando o evento
  ‚Ä¢ P√°gina do venue listando o evento na agenda oficial
  ‚Ä¢ Blog cultural confi√°vel detalhando o evento
- Se N√ÉO encontrar nenhum link: use null (sem aspas) e CONTINUE
- NUNCA deixe de incluir um evento s√≥ porque n√£o tem link - informa√ß√µes de data, hor√°rio, local e descri√ß√£o s√£o muito mais importantes
- Links devem come√ßar com http:// ou https:// (se fornecidos)

IMPORTANTE GERAL - MAXIMIZE COBERTURA:
- Busque o M√ÅXIMO de eventos poss√≠vel (objetivo: pelo menos 3 eventos por categoria)
- Verifique m√∫ltiplas fontes para cada categoria
- INCLUA TODOS os eventos que encontrar com data, hor√°rio, local e descri√ß√£o - mesmo sem link
- A completude √© medida por: data v√°lida + hor√°rio + local + descri√ß√£o (link √© OPCIONAL)
- Inclua fontes/cita√ß√µes das informa√ß√µes encontradas
"""

        # BUSCA 2: Locais ESPEC√çFICOS (venue-based strategy)
        prompt_locais_especiais = f"""
Execute uma busca ULTRA-ESPEC√çFICA e DETALHADA para 3 VENUES hist√≥ricos e culturais do Rio de Janeiro.

PER√çODO: {SEARCH_CONFIG['start_date'].strftime('%d/%m/%Y')} a {SEARCH_CONFIG['end_date'].strftime('%d/%m/%Y')}

ESTRAT√âGIA DE BUSCA MULTI-STEP:

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VENUE 1: CASA DO CHORO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Endere√ßo: Rua da Carioca, 38 - Centro, Rio de Janeiro

PASSO 1 - Buscar site oficial e redes sociais:
- Site: casadochoro.com.br
- Instagram: @casadochororj
- Facebook: Casa do Choro oficial
- Telefone para eventos: buscar contato oficial

PASSO 2 - Buscar em plataformas de venda:
- Sympla: "Casa do Choro" + "{month_year_str}"
- Eventbrite: "Casa do Choro Rio"
- Site pr√≥prio de vendas

PASSO 3 - Buscar em portais culturais:
- "agenda Casa do Choro {month_year_str}"
- "shows Casa do Choro pr√≥ximas semanas"
- "eventos Casa do Choro Rio de Janeiro"

PASSO 4 - Tipos de eventos neste local:
- Rodas de choro
- Shows de choro tradicional e contempor√¢neo
- Lan√ßamentos de √°lbuns
- Concertos did√°ticos
- Eventos da escola de m√∫sica

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VENUE 2: SALA CEC√çLIA MEIRELLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Endere√ßo: Largo da Lapa, 47 - Lapa, Rio de Janeiro

PASSO 1 - Buscar site oficial:
- Site: salaceliciameireles.com.br
- Instagram: @salacecialiameirelles
- Secretaria de Cultura RJ

PASSO 2 - Tipos de eventos (m√∫sica erudita):
- Concertos sinf√¥nicos
- M√∫sica de c√¢mara
- Recitais de piano, violino, etc
- Corais
- √ìpera

PASSO 3 - Palavras-chave espec√≠ficas:
- "Sala Cec√≠lia Meirelles agenda {month_year_str}"
- "concertos Sala Cec√≠lia Meirelles Rio"
- "m√∫sica erudita Rio de Janeiro pr√≥ximas semanas"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VENUE 3: TEATRO MUNICIPAL DO RIO DE JANEIRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Endere√ßo: Pra√ßa Floriano, s/n - Centro, Rio de Janeiro

PASSO 1 - Buscar site oficial:
- Site: theatromunicipal.rj.gov.br
- Instagram: @theatromunicipalrj
- Funda√ß√£o Theatro Municipal do Rio de Janeiro

PASSO 2 - Tipos de eventos:
- √ìperas
- Bal√©s
- Concertos da Orquestra Sinf√¥nica Brasileira (OSB)
- Espet√°culos de dan√ßa cl√°ssica
- Eventos especiais

PASSO 3 - Palavras-chave espec√≠ficas:
- "Teatro Municipal Rio programa√ß√£o {month_year_str}"
- "√≥pera ballet Teatro Municipal Rio"
- "OSB Orquestra Sinf√¥nica Brasileira pr√≥ximos concertos"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VENUE 4: ARTEMIS TORREFA√á√ÉO (Cursos e Eventos de Caf√©)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Endere√ßos: Ipanema (Rua Visconde de Piraj√°), Leblon, outras unidades no Rio

PASSO 1 - Buscar site oficial e redes sociais:
- Site: artemistorrefacao.com.br
- Instagram: @artemistorrefacao
- Facebook: Artemis Torrefa√ß√£o oficial
- Agenda de cursos e workshops

PASSO 2 - Tipos de eventos:
- Cursos de barista (b√°sico, intermedi√°rio, avan√ßado)
- Degusta√ß√µes guiadas de caf√©
- Workshops de preparo de caf√© (V60, Chemex, Aeropress)
- Lan√ßamentos de caf√©s especiais
- Coffee tasting e cupping sessions
- Eventos de caf√© e harmoniza√ß√£o

PASSO 3 - Palavras-chave espec√≠ficas:
- "Artemis Torrefa√ß√£o cursos {month_year_str}"
- "workshop caf√© Artemis Rio"
- "curso barista Ipanema Rio de Janeiro"
- "degusta√ß√£o caf√© especialidade Rio"
- "eventos caf√© Artemis Torrefa√ß√£o agenda"

PASSO 4 - Buscar em:
- Site oficial (se√ß√£o de cursos/eventos)
- Instagram Stories e Posts recentes
- Sympla: "Artemis Torrefa√ß√£o"
- Eventbrite: "curso caf√© Rio"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

INSTRU√á√ïES CR√çTICAS:
1. Para CADA venue, buscar em M√öLTIPLAS fontes (site oficial, redes sociais, Sympla, portais culturais)
2. Se site oficial n√£o estiver acess√≠vel, usar portais: TimeOut Rio, O Globo Cultura, Veja Rio, Riotur
3. Verificar redes sociais oficiais para eventos rec√©m-anunciados
4. Buscar tamb√©m "pr√≥ximos eventos [nome do venue]", "agenda [nome do venue]"
5. Se n√£o encontrar eventos, EXPLICAR que buscou em X fontes e n√£o h√° eventos no per√≠odo

INFORMA√á√ïES OBRIGAT√ìRIAS:
- Nome completo do evento
- Data (DD/MM/YYYY)
- Hor√°rio
- Local (especificar qual dos 3 venues)
- Pre√ßo (ou "Gratuito", ou "Consultar")
- Link para compra ou mais informa√ß√µes (URL completa ou null)
- Descri√ß√£o: tipo de evento, artistas, repert√≥rio

IMPORTANTE SOBRE LINKS (SECUND√ÅRIOS):
- PRIORIDADE M√ÅXIMA: encontrar TODOS os eventos destes venues hist√≥ricos no per√≠odo
- Links s√£o OPCIONAIS - temos busca complementar que preenche depois
- PRIORIZE links de compra (Sympla, Eventbrite, site oficial do venue)
- ACEITE links informativos: posts do venue no Instagram/Facebook, p√°gina de agenda oficial, not√≠cias/artigos sobre o evento
- Se N√ÉO encontrar nenhum link: use null e CONTINUE buscando mais eventos
- NUNCA deixe de incluir um evento s√≥ porque n√£o conseguiu o link
- O que importa: nome do evento, data, hor√°rio, descri√ß√£o, artistas - link vem depois

FORMATO DE RETORNO:
{{
  "Casa do Choro": [lista de eventos],
  "Sala Cec√≠lia Meirelles": [lista de eventos],
  "Teatro Municipal do Rio de Janeiro": [lista de eventos]
}}

M√çNIMO ESPERADO: Pelo menos 1 evento por venue (se dispon√≠vel no per√≠odo)
IMPORTANTE: Se o venue tiver mais eventos, INCLUA TODOS - n√£o limite artificialmente a busca
"""

        try:
            # OTIMIZAR prompts antes de buscar
            logger.info("üß† Otimizando prompts com Query Optimizer...")
            prompt_geral_optimized = self.optimize_search_prompt(prompt_geral, "busca geral")
            prompt_especial_optimized = self.optimize_search_prompt(prompt_locais_especiais, "locais espec√≠ficos")

            # Executar DUAS buscas separadas com prompts otimizados
            logger.info("Executando busca GERAL de eventos (com prompt otimizado)...")
            response_geral = self.search_agent.run(prompt_geral_optimized)
            events_geral = response_geral.content

            logger.info("Executando busca ESPEC√çFICA para locais hist√≥ricos (com prompt otimizado)...")
            response_especial = self.search_agent.run(prompt_especial_optimized)
            events_especial = response_especial.content

            logger.info(f"Buscas conclu√≠das com Perplexity (2 consultas)")

            return {
                "perplexity_geral": events_geral,
                "perplexity_especial": events_especial,
                "search_timestamp": datetime.now().isoformat(),
            }
        except Exception as e:
            logger.error(f"Erro na busca com Perplexity: {e}")
            return {
                "perplexity_geral": "{}",
                "perplexity_especial": "{}",
                "search_timestamp": datetime.now().isoformat(),
            }

    def _find_event_ticket_link_batch(self, events_batch: list[dict]) -> dict[str, str]:
        """Busca links de m√∫ltiplos eventos em uma √∫nica chamada (batch)."""
        if not events_batch:
            return {}

        # Construir prompt com lista de eventos
        eventos_texto = []
        for i, event in enumerate(events_batch, 1):
            titulo = event.get("titulo", "")
            data = event.get("data", "")
            local = event.get("local", "")
            eventos_texto.append(f"{i}. {titulo} - {data} - {local}")

        prompt = f"""Encontre os links de compra/informa√ß√µes para estes {len(events_batch)} eventos no Rio de Janeiro:

{chr(10).join(eventos_texto)}

Para CADA evento, busque o link espec√≠fico em:
- Sympla (sympla.com.br)
- Eventbrite (eventbrite.com.br)
- Site oficial do venue (Blue Note, Dolores Club, Casa do Choro, etc)
- Instagram oficial (se tiver link de venda)

Retorne no formato JSON:
{{
  "1": "URL completo ou null",
  "2": "URL completo ou null",
  ...
}}

IMPORTANTE:
- Use null (sem aspas) se n√£o encontrar link confi√°vel
- N√ÉO retorne links gen√©ricos de homepage
- Links devem come√ßar com http:// ou https://
"""

        try:
            response = self.search_agent.run(prompt)
            content = response.content.strip()

            # Limpar markdown
            if "```json" in content:
                content = content.split("```json")[1].split("```")[0].strip()
            elif "```" in content:
                content = content.split("```")[1].split("```")[0].strip()

            # Parse JSON
            links_map = json.loads(content)

            # Converter chaves para int se necess√°rio
            result = {}
            for key, value in links_map.items():
                result[str(key)] = value if value and value != "null" else None

            return result

        except Exception as e:
            logger.error(f"Erro na busca batch de links: {e}")
            return {}

    def _search_missing_links(self, events: list[dict]) -> list[dict]:
        """Busca links para eventos que n√£o t√™m link, processando em batches."""
        # Identificar eventos sem link
        events_without_links = []
        events_indices = []

        for i, event in enumerate(events):
            if not event.get("link_ingresso"):
                events_without_links.append(event)
                events_indices.append(i)

        if not events_without_links:
            logger.info("Todos os eventos j√° possuem links")
            return events

        logger.info(f"üîó Buscando links para {len(events_without_links)} eventos sem link...")

        # Processar em batches de 5
        batch_size = 5
        total_found = 0

        for batch_start in range(0, len(events_without_links), batch_size):
            batch_end = min(batch_start + batch_size, len(events_without_links))
            batch = events_without_links[batch_start:batch_end]

            logger.info(f"   Processando batch {batch_start//batch_size + 1} ({len(batch)} eventos)...")

            # Buscar links para este batch
            links_map = self._find_event_ticket_link_batch(batch)

            # Atribuir links encontrados
            for local_idx, event in enumerate(batch):
                batch_key = str(local_idx + 1)
                if batch_key in links_map and links_map[batch_key]:
                    event["link_ingresso"] = links_map[batch_key]
                    event["link_source"] = "busca_complementar_batch"
                    total_found += 1
                    logger.info(f"   ‚úì Link encontrado para: {event.get('titulo')}")

        logger.info(f"‚úì Busca complementar conclu√≠da: {total_found}/{len(events_without_links)} links encontrados")
        return events

    def process_with_llm(self, raw_events: dict[str, Any]) -> str:
        """Combina e limpa resultados das duas buscas Perplexity."""
        logger.info("Combinando dados das 2 buscas Perplexity...")

        # Extrair dados das duas buscas
        data_geral = raw_events.get("perplexity_geral", "{}")
        data_especial = raw_events.get("perplexity_especial", "{}")

        # Limpar markdown code blocks e coment√°rios
        def clean_json(data):
            # Remover markdown code blocks
            if "```json" in data:
                data = data.split("```json")[1].split("```")[0].strip()
            elif "```" in data:
                data = data.split("```")[1].split("```")[0].strip()

            # Remover coment√°rios JavaScript (// coment√°rios) linha por linha
            lines = data.split("\n")
            cleaned_lines = []
            for line in lines:
                # Se a linha cont√©m //, remover tudo a partir da√≠ (exceto se estiver dentro de string)
                if "//" in line:
                    # Verificar se est√° dentro de string
                    in_string = False
                    quote_char = None
                    result = []
                    i = 0
                    while i < len(line):
                        char = line[i]
                        if char in ['"', "'"]:
                            if not in_string:
                                in_string = True
                                quote_char = char
                            elif char == quote_char and (i == 0 or line[i - 1] != "\\"):
                                in_string = False
                                quote_char = None
                            result.append(char)
                        elif char == "/" and i + 1 < len(line) and line[i + 1] == "/" and not in_string:
                            # Coment√°rio encontrado fora de string, parar aqui
                            break
                        else:
                            result.append(char)
                        i += 1
                    line = "".join(result).rstrip()
                cleaned_lines.append(line)

            # Remover linhas vazias
            cleaned_lines = [line for line in cleaned_lines if line.strip()]

            return "\n".join(cleaned_lines)

        data_geral_clean = clean_json(data_geral)
        data_especial_clean = clean_json(data_especial)

        # Combinar em um √∫nico JSON
        combined = f'{{"eventos_gerais": {data_geral_clean}, "eventos_locais_especiais": {data_especial_clean}}}'

        logger.info("Dados combinados das 2 buscas")

        # Parsear para aplicar busca complementar de links
        try:
            combined_data = json.loads(combined)

            # Extrair todos os eventos para busca complementar
            all_events = []

            # Eventos gerais
            if "eventos_gerais" in combined_data and "eventos" in combined_data["eventos_gerais"]:
                all_events.extend(combined_data["eventos_gerais"]["eventos"])

            # Eventos de locais especiais
            if "eventos_locais_especiais" in combined_data:
                for local_name, local_events in combined_data["eventos_locais_especiais"].items():
                    if isinstance(local_events, list):
                        all_events.extend([e for e in local_events if isinstance(e, dict)])

            # Aplicar busca complementar de links
            if all_events:
                self._search_missing_links(all_events)

            # Retornar JSON atualizado
            return json.dumps(combined_data, ensure_ascii=False, indent=2)

        except json.JSONDecodeError as e:
            logger.error(f"Erro ao parsear JSON combinado: {e}")
            return combined
